<!DOCTYPE html>
<html lang='en'>

<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <meta http-equiv='X-UA-Compatible' content='ie=edge'>
    <title>Fwdays scan QR 0.4</title>
    <style>
        #video {
            z-index: 2;
        }

        .controls {
            margin-top: 20px;
            display: flex;
        }

        canvas {
            position: absolute;
            top: 0;
            left: -9999px;
            z-index: 0;
        }
    </style>
</head>

<body>
    <div id='camera'>
        <video id="video"></video>
        <div class='controls'>
            <button class='stop'>Stop Camera</button>
            <button class='start'>Start Camera</button>
        </div>
    </div>
    <script src="./qr-scanner.js" defer></script>
    <script>
        const constraints = {
            audio: false,
            video: {
                width: 250,
                height: 250,
                facingMode: "environment",
                frameRate: { max: 30 },
            }
        };
        const video = document.querySelector('#video');
        // Older browsers might not implement mediaDevices at all, so we set an empty object first
            if (navigator.mediaDevices === undefined) {
                navigator.mediaDevices = {};
            }

            // Some browsers partially implement mediaDevices. We can't just assign an object
            // with getUserMedia as it would overwrite existing properties.
            // Here, we will just add the getUserMedia property if it's missing.
            if (navigator.mediaDevices.getUserMedia === undefined) {
                navigator.mediaDevices.getUserMedia = function (constraints) {

                    // First get ahold of the legacy getUserMedia, if present
                    var getUserMedia = navigator.webkitGetUserMedia || navigator.mozGetUserMedia;

                    // Some browsers just don't implement it - return a rejected promise with an error
                    // to keep a consistent interface
                    if (!getUserMedia) {
                        return Promise.reject(new Error('getUserMedia is not implemented in this browser'));
                    }

                    // Otherwise, wrap the call to the old navigator.getUserMedia with a Promise
                    return new Promise(function (resolve, reject) {
                        getUserMedia.call(navigator, constraints, resolve, reject);
                    });
                }
            }
                
        function startCamera(params) {
            navigator.mediaDevices.getUserMedia(constraints)
                .then(function (stream) {
                    var video = document.querySelector('video');
                    // Older browsers may not have srcObject
                    if ("srcObject" in video) {
                        video.srcObject = stream;
                    } else {
                        // Avoid using this in new browsers, as it is going away.
                        video.src = window.URL.createObjectURL(stream);
                    }
                    video.onloadedmetadata = function (e) {
                        video.play();
                    };
                })
                .catch(function (err) {
                    console.log(err.name + ": " + err.message);
                });
        }
        document.querySelector('.stop').addEventListener('click', (e) => {
            document.querySelector('video').srcObject.getTracks().forEach(track => track.stop());
        })
        document.querySelector('.start').addEventListener('click', (e) => {
            startCamera();
        })

        QCodeDecoder()
            .decodeFromVideo(video, function (er, res) {
                if (res) {
                    const url = new URL(res, 'https://fwdays.com');
                    if (url.href) {
                        window.open(url.href, '_blank');
                    }
                }
            });
        </script>
</body>

</html>